var isDefined=angular.isDefined,isUndefined=angular.isUndefined,isNumber=angular.isNumber,isObject=angular.isObject,isArray=angular.isArray,isString=angular.isString,extend=angular.extend,toJson=angular.toJson;angular.module("LocalStorageModule",[]).provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/",secure:!1},this.defaultToCookie=!0,this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(a){return this.prefix=a,this},this.setStorageType=function(a){return this.storageType=a,this},this.setDefaultToCookie=function(a){return this.defaultToCookie=!!a,this},this.setStorageCookie=function(a,b,c){return this.cookie.expiry=a,this.cookie.path=b,this.cookie.secure=c,this},this.setStorageCookieDomain=function(a){return this.cookie.domain=a,this},this.setNotify=function(a,b){return this.notify={setItem:a,removeItem:b},this},this.$get=["$rootScope","$window","$document","$parse","$timeout",function(a,b,c,d,e){function f(c){if(c||(c=b.event),k.setItem&&isString(c.key)&&o(c.key)){var d=n(c.key);e(function(){a.$broadcast("LocalStorageModule.notification.changed",{key:d,newvalue:c.newValue,storageType:h.storageType})})}}var g,h=this,i=h.prefix,j=h.cookie,k=h.notify,l=h.storageType;c?c[0]&&(c=c[0]):c=document,"."!==i.substr(-1)&&(i=i?i+".":"");var m=function(a){return i+a},n=function(a){return a.replace(new RegExp("^"+i,"g"),"")},o=function(a){return 0===a.indexOf(i)},p=function(){try{var c=l in b&&null!==b[l],d=m("__"+Math.round(1e7*Math.random()));return c&&(g=b[l],g.setItem(d,""),g.removeItem(d)),c}catch(e){return h.defaultToCookie&&(l="cookie"),a.$broadcast("LocalStorageModule.notification.error",e.message),!1}},q=p(),r=function(b,c,d){var e=B();try{if(C(d),c=isUndefined(c)?null:toJson(c),!q&&h.defaultToCookie||"cookie"===h.storageType)return q||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),k.setItem&&a.$broadcast("LocalStorageModule.notification.setitem",{key:b,newvalue:c,storageType:"cookie"}),x(b,c);try{g&&g.setItem(m(b),c),k.setItem&&a.$broadcast("LocalStorageModule.notification.setitem",{key:b,newvalue:c,storageType:h.storageType})}catch(f){return a.$broadcast("LocalStorageModule.notification.error",f.message),x(b,c)}return!0}finally{C(e)}},s=function(b,c){var d=B();try{if(C(c),!q&&h.defaultToCookie||"cookie"===h.storageType)return q||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),y(b);var e=g?g.getItem(m(b)):null;if(!e||"null"===e)return null;try{return JSON.parse(e)}catch(f){return e}}finally{C(d)}},t=function(){var b=B();try{var c=0;arguments.length>=1&&("localStorage"===arguments[arguments.length-1]||"sessionStorage"===arguments[arguments.length-1])&&(c=1,C(arguments[arguments.length-1]));var d,e;for(d=0;d<arguments.length-c;d++)if(e=arguments[d],!q&&h.defaultToCookie||"cookie"===h.storageType)q||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),k.removeItem&&a.$broadcast("LocalStorageModule.notification.removeitem",{key:e,storageType:"cookie"}),z(e);else try{g.removeItem(m(e)),k.removeItem&&a.$broadcast("LocalStorageModule.notification.removeitem",{key:e,storageType:h.storageType})}catch(f){a.$broadcast("LocalStorageModule.notification.error",f.message),z(e)}}finally{C(b)}},u=function(b){var c=B();try{if(C(b),!q)return a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),[];var d=i.length,e=[];for(var f in g)if(f.substr(0,d)===i)try{e.push(f.substr(d))}catch(h){return a.$broadcast("LocalStorageModule.notification.error",h.Description),[]}return e}finally{C(c)}},v=function(b,c){var d=B();try{C(c);var e=i?new RegExp("^"+i):new RegExp,f=b?new RegExp(b):new RegExp;if(!q&&h.defaultToCookie||"cookie"===h.storageType)return q||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),A();if(!q&&!h.defaultToCookie)return!1;var j=i.length;for(var k in g)if(e.test(k)&&f.test(k.substr(j)))try{t(k.substr(j))}catch(l){return a.$broadcast("LocalStorageModule.notification.error",l.message),A()}return!0}finally{C(d)}},w=function(){try{return b.navigator.cookieEnabled||"cookie"in c&&(c.cookie.length>0||(c.cookie="test").indexOf.call(c.cookie,"test")>-1)}catch(d){return a.$broadcast("LocalStorageModule.notification.error",d.message),!1}}(),x=function(b,d,e,f){if(isUndefined(d))return!1;if((isArray(d)||isObject(d))&&(d=toJson(d)),!w)return a.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var g="",h=new Date,i="";if(null===d?(h.setTime(h.getTime()+-864e5),g="; expires="+h.toGMTString(),d=""):isNumber(e)&&0!==e?(h.setTime(h.getTime()+24*e*60*60*1e3),g="; expires="+h.toGMTString()):0!==j.expiry&&(h.setTime(h.getTime()+24*j.expiry*60*60*1e3),g="; expires="+h.toGMTString()),b){var k="; path="+j.path;j.domain&&(i="; domain="+j.domain),"boolean"==typeof f?f===!0&&(i+="; secure"):j.secure===!0&&(i+="; secure"),c.cookie=m(b)+"="+encodeURIComponent(d)+g+k+i}}catch(l){return a.$broadcast("LocalStorageModule.notification.error",l.message),!1}return!0},y=function(b){if(!w)return a.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var d=c.cookie&&c.cookie.split(";")||[],e=0;e<d.length;e++){for(var f=d[e];" "===f.charAt(0);)f=f.substring(1,f.length);if(0===f.indexOf(m(b)+"=")){var g=decodeURIComponent(f.substring(i.length+b.length+1,f.length));try{var h=JSON.parse(g);return"number"==typeof h?g:h}catch(j){return g}}}return null},z=function(a){x(a,null)},A=function(){for(var a=null,b=i.length,d=c.cookie.split(";"),e=0;e<d.length;e++){for(a=d[e];" "===a.charAt(0);)a=a.substring(1,a.length);var f=a.substring(b,a.indexOf("="));z(f)}},B=function(){return l},C=function(a){return a&&l!==a&&(l=a,q=p()),q},D=function(a,b,c,e,f){e=e||b;var g=s(e,f);return null===g&&isDefined(c)?g=c:isObject(g)&&isObject(c)&&(g=extend(g,c)),d(b).assign(a,g),a.$watch(b,function(a){r(e,a,f)},isObject(a[b]))};q&&(b.addEventListener?(b.addEventListener("storage",f,!1),a.$on("$destroy",function(){b.removeEventListener("storage",f)})):b.attachEvent&&(b.attachEvent("onstorage",f),a.$on("$destroy",function(){b.detachEvent("onstorage",f)})));var E=function(a){var c=B();try{C(a);for(var d=0,e=b[l],f=0;f<e.length;f++)0===e.key(f).indexOf(i)&&d++;return d}finally{C(c)}};return{isSupported:q,getStorageType:B,setStorageType:C,set:r,add:r,get:s,keys:u,remove:t,clearAll:v,bind:D,deriveKey:m,underiveKey:n,length:E,defaultToCookie:this.defaultToCookie,cookie:{isSupported:w,set:x,add:x,get:y,remove:z,clearAll:A}}}]});